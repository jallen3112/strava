<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>{{ map_title }}</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
        .mapboxgl-ctrl-logo { display: none !important; } /* hide Mapbox logo */
        .mapboxgl-ctrl-attrib { display: none !important; } /* hide attribution */
    </style>
</head>
<body>
<div id="map"></div>
<script>
    mapboxgl.accessToken = "{{ mapbox_token }}";
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/outdoors-v12',
        center: {{ centre | tojson }},
        zoom: 13,
        pitch: 60,
        bearing: 55,
        antialias: true,
        attributionControl: false  // disables attribution control
    });

    map.on('load', () => {
        map.addSource('mapbox-dem', {
            type: "raster-dem",
            url: "mapbox://mapbox.terrain-rgb",
            tileSize: 512,
            maxzoom: 14
        });
        map.setTerrain({ source: "mapbox-dem", exaggeration: 1.6 });

        // 3D buildings
        const layers = map.getStyle().layers;
        let labelLayerId;
        for (let i = 0; i < layers.length; i++) {
            if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
                labelLayerId = layers[i].id;
                break;
            }
        }
        map.addLayer({
            id: '3d-buildings',
            source: 'composite',
            'source-layer': 'building',
            filter: ['==', 'extrude', 'true'],
            type: 'fill-extrusion',
            minzoom: 15,
            paint: {
                'fill-extrusion-color': '#aaa',
                'fill-extrusion-height': [
                    'interpolate', ['linear'], ['zoom'],
                    15, 0,
                    15.05, ['get', 'height']
                ],
                'fill-extrusion-base': [
                    'interpolate', ['linear'], ['zoom'],
                    15, 0,
                    15.05, ['get', 'min_height']
                ],
                'fill-extrusion-opacity': 0.6
            }
        }, labelLayerId);

        // Route
        map.addLayer({
            id: "route",
            type: "line",
            source: {
                type: "geojson",
                data: {
                    type: "Feature",
                    geometry: {
                        type: "LineString",
                        coordinates: {{ coordinates_js | tojson }}
                    }
                }
            },
            layout: { "line-join": "round", "line-cap": "round" },
            paint: { "line-color": "#ff6f61", "line-width": 2.5 }
        });

        // Fit route bounds
        const routeBounds = new mapboxgl.LngLatBounds();
        {{ coordinates_js | tojson }}.forEach(coord => routeBounds.extend(coord));
        map.fitBounds(routeBounds, { padding: 80, maxZoom: 17, duration: 2000 });
    });
</script>
</body>
</html>